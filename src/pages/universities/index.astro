---
import "../../styles/universities.scss";
import Layout from "../../layouts/Layout.astro";
import UniversityCard from "../../components/Home/University/UniversityCard.astro";
import type { UniversityCard as UniversityCardType } from "@/lib/types/university";

// Import universities data
import universitiesData from "../../lib/data/universities.json";
import Dropdown from "@/components/common/Dropdown.astro";
import ListHero from "@/components/common/ListHero.astro";

// Render this page on the server so query params are available at runtime
export const prerender = false;

// Get URL search params
const url = Astro.url;
const country = url.searchParams.get("country");
const degree = url.searchParams.get("degree");
const specialization = url.searchParams.get("specialization");
const minFee = url.searchParams.get("minFee");
const maxFee = url.searchParams.get("maxFee");

const countriesSelected = country
  ? country
      .split(",")
      .map((v) => v.trim())
      .filter(Boolean)
  : [];

// Extract unique filter options
const countries = [...new Set(universitiesData.map((u) => u.country))].sort();
const degrees = [...new Set(universitiesData.flatMap((u) => u.degrees))].sort();
const specializations = [
  ...new Set(universitiesData.flatMap((u) => u.specializations)),
].sort();

// Filter universities based on search params
let filteredUniversities = universitiesData;

if (countriesSelected.length) {
  filteredUniversities = filteredUniversities.filter((u) =>
    countriesSelected.includes(u.country),
  );
}

if (degree) {
  filteredUniversities = filteredUniversities.filter((u) =>
    u.degrees.includes(degree),
  );
}

if (specialization) {
  filteredUniversities = filteredUniversities.filter((u) =>
    u.specializations.includes(specialization),
  );
}

if (minFee) {
  const min = parseFloat(minFee);
  filteredUniversities = filteredUniversities.filter((u) => u.min_fee >= min);
}

if (maxFee) {
  const max = parseFloat(maxFee);
  filteredUniversities = filteredUniversities.filter((u) => u.max_fee <= max);
}

// Convert to card format
const universityCards: UniversityCardType[] = filteredUniversities.map((u) => ({
  name: u.name,
  slug: u.slug,
  city: u.city,
  country: u.country,
  image_url: u.image_url,
}));

const pageTitle = country
  ? `Universities in ${country} | Study Abroad`
  : "Top Universities Worldwide | Filter & Explore";
const pageDescription = country
  ? `Discover top universities in ${country}. Browse ${filteredUniversities.length} universities and find the perfect match for your academic goals.`
  : `Explore ${filteredUniversities.length} top universities worldwide. Use filters to find the best fit for your academic goals.`;

// Active filters count
const activeFiltersCount = [
  countriesSelected.length ? String(countriesSelected.length) : "",
  degree,
  specialization,
  minFee,
  maxFee,
].filter(Boolean).length;
---

<Layout
  title={pageTitle}
  description={pageDescription}
  mainClass="universities-main"
>
  <ListHero
    title="Universities"
    description="Browse universities worldwide and filter by your preferences."
  />
  <section class="universities-content">
    <div class="content-container">
      <div class="mobile-filter-header">
        <button class="filter-toggle-btn" id="filterToggle">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
          <span>Filters</span>
          {
            activeFiltersCount > 0 && (
              <span class="filter-count">{activeFiltersCount}</span>
            )
          }
        </button>
      </div>

      <div class="universities-grid">
        <aside class="filters-sidebar" id="filtersSidebar">
          <div class="filters-header">
            <h2>Filters</h2>
            {
              activeFiltersCount > 0 && (
                <a href="/universities" class="clear-filters-btn">
                  Clear All
                </a>
              )
            }
          </div>

          <form class="filters-form" id="filtersForm">
            <!-- Country Filter -->
            <div class="filter-group">
              <Dropdown
                options={countries}
                name="country"
                label="Country"
                selectedValue={country || ""}
                placeholder="All Countries"
                maxOptionsToShow={8}
                isMulti={true}
              />
            </div>
            <!-- Degree Filter -->
            <div class="filter-group">
              <Dropdown
                options={degrees}
                name="degree"
                label="Degree"
                selectedValue={degree || ""}
                placeholder="All Degrees"
                maxOptionsToShow={6}
              />
            </div>

            <!-- Specialization Filter -->
            <div class="filter-group">
              <Dropdown
                options={specializations}
                name="specialization"
                label="Specialization"
                selectedValue={specialization || ""}
                placeholder="All Specializations"
                maxOptionsToShow={8}
              />
            </div>

            <!-- Fee Range Filter -->
            <div class="filter-group">
              <label class="filter-label">Tuition Fee (USD/year)</label>
              <div class="fee-range-inputs">
                <input
                  type="number"
                  name="minFee"
                  placeholder="Min"
                  value={minFee || ""}
                  class="filter-input"
                  min="0"
                  step="1000"
                />
                <span class="range-separator">-</span>
                <input
                  type="number"
                  name="maxFee"
                  placeholder="Max"
                  value={maxFee || ""}
                  class="filter-input"
                  min="0"
                  step="1000"
                />
              </div>
            </div>

            <button type="submit" class="apply-filters-btn"
              >Apply Filters</button
            >
          </form>

          {
            activeFiltersCount > 0 && (
              <div class="active-filters">
                <h3 class="active-filters-title">Active Filters:</h3>
                <div class="filter-tags">
                  {countriesSelected.length > 0 &&
                    countriesSelected.map((c) => {
                      const params = new URLSearchParams(
                        Object.fromEntries(url.searchParams.entries()),
                      );
                      const current = params.get("country");
                      if (current) {
                        const rest = current
                          .split(",")
                          .map((v) => v.trim())
                          .filter(Boolean)
                          .filter((v) => v !== c);
                        if (rest.length) {
                          params.set("country", rest.join(","));
                        } else {
                          params.delete("country");
                        }
                      }
                      const qs = params.toString();
                      const href = qs ? `/universities?${qs}` : "/universities";
                      return (
                        <a href={href} class="filter-tag">
                          {c}
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="14"
                            height="14"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                          >
                            <path d="M18 6L6 18M6 6l12 12" />
                          </svg>
                        </a>
                      );
                    })}
                  {degree && (
                    <a
                      href={`/universities?${new URLSearchParams(
                        Object.fromEntries(url.searchParams.entries()),
                      )
                        .toString()
                        .replace(/&?degree=[^&]*/, "")
                        .replace(/^&/, "")}`}
                      class="filter-tag"
                    >
                      {degree}
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="14"
                        height="14"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path d="M18 6L6 18M6 6l12 12" />
                      </svg>
                    </a>
                  )}
                  {specialization && (
                    <a
                      href={`/universities?${new URLSearchParams(
                        Object.fromEntries(url.searchParams.entries()),
                      )
                        .toString()
                        .replace(/&?specialization=[^&]*/, "")
                        .replace(/^&/, "")}`}
                      class="filter-tag"
                    >
                      {specialization}
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="14"
                        height="14"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path d="M18 6L6 18M6 6l12 12" />
                      </svg>
                    </a>
                  )}
                </div>
              </div>
            )
          }
        </aside>

        <main class="universities-main-content">
          {
            universityCards.length > 0 ? (
              <div class="universities-list">
                {universityCards.map((university) => (
                  <UniversityCard universityCardData={university} />
                ))}
              </div>
            ) : (
              <div class="no-results">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="64"
                  height="64"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                >
                  <circle cx="11" cy="11" r="8" />
                  <path d="m21 21-4.35-4.35" />
                </svg>
                <h3>No universities found</h3>
                <p>Try adjusting your filters to see more results</p>
                <a href="/universities" class="reset-btn">
                  Reset Filters
                </a>
              </div>
            )
          }
        </main>
      </div>
    </div>
  </section>

  <div class="filter-overlay" id="filterOverlay"></div>
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const filterToggle = document.getElementById("filterToggle");
    const filtersSidebar = document.getElementById("filtersSidebar");
    const filterOverlay = document.getElementById("filterOverlay");
    const filtersForm = document.getElementById(
      "filtersForm",
    ) as HTMLFormElement;

    // Mobile filter toggle
    filterToggle?.addEventListener("click", function () {
      filtersSidebar?.classList.toggle("active");
      filterOverlay?.classList.toggle("active");
      document.body.classList.toggle("filter-open");
    });

    filterOverlay?.addEventListener("click", function () {
      filtersSidebar?.classList.remove("active");
      filterOverlay?.classList.remove("active");
      document.body.classList.remove("filter-open");
    });

    // Handle form submission
    filtersForm?.addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(filtersForm);
      const params = new URLSearchParams();

      formData.forEach((value, key) => {
        if (value && value.toString().trim() !== "") {
          params.append(key, value.toString());
        }
      });

      const queryString = params.toString();
      window.location.href = queryString
        ? `/universities?${queryString}`
        : "/universities";
    });
  });
</script>
