---
import "../../styles/universities.scss";
import Layout from "../../layouts/Layout.astro";
import UniversityCard from "../../components/Home/University/UniversityCard.astro";
import type { UniversityCard as UniversityCardType } from "@/lib/types/university";

// Import universities data
import universitiesData from "../../lib/data/universities.json";
import Dropdown from "@/components/common/Dropdown.astro";

// Get URL search params
const url = Astro.url;
const country = url.searchParams.get("country");
const degree = url.searchParams.get("degree");
const specialization = url.searchParams.get("specialization");
const minFee = url.searchParams.get("minFee");
const maxFee = url.searchParams.get("maxFee");

// Extract unique filter options
const countries = [...new Set(universitiesData.map((u) => u.country))].sort();
const degrees = [...new Set(universitiesData.flatMap((u) => u.degrees))].sort();
const specializations = [
  ...new Set(universitiesData.flatMap((u) => u.specializations)),
].sort();

// Filter universities based on search params
let filteredUniversities = universitiesData;

if (country) {
  filteredUniversities = filteredUniversities.filter(
    (u) => u.country === country
  );
}

if (degree) {
  filteredUniversities = filteredUniversities.filter((u) =>
    u.degrees.includes(degree)
  );
}

if (specialization) {
  filteredUniversities = filteredUniversities.filter((u) =>
    u.specializations.includes(specialization)
  );
}

if (minFee) {
  const min = parseFloat(minFee);
  filteredUniversities = filteredUniversities.filter((u) => u.min_fee >= min);
}

if (maxFee) {
  const max = parseFloat(maxFee);
  filteredUniversities = filteredUniversities.filter((u) => u.max_fee <= max);
}

// Convert to card format
const universityCards: UniversityCardType[] = filteredUniversities.map((u) => ({
  name: u.name,
  slug: u.slug,
  city: u.city,
  country: u.country,
  image_url: u.image_url,
}));

const pageTitle = country
  ? `Universities in ${country} | Study Abroad`
  : "Top Universities Worldwide | Filter & Explore";
const pageDescription = country
  ? `Discover top universities in ${country}. Browse ${filteredUniversities.length} universities and find the perfect match for your academic goals.`
  : `Explore ${filteredUniversities.length} top universities worldwide. Use filters to find the best fit for your academic goals.`;

// Active filters count
const activeFiltersCount = [
  country,
  degree,
  specialization,
  minFee,
  maxFee,
].filter(Boolean).length;
---

<Layout
  title={pageTitle}
  description={pageDescription}
  mainClass="universities-main"
>
  <section class="universities-content">
    <div class="content-container">
      <div class="page-header">
        <h1>Discover Universities</h1>
        <p class="results-count">
          Showing <strong>{filteredUniversities.length}</strong>
          {filteredUniversities.length === 1 ? "university" : "universities"}
        </p>
      </div>

      <div class="mobile-filter-header">
        <button class="filter-toggle-btn" id="filterToggle">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
          <span>Filters</span>
          {
            activeFiltersCount > 0 && (
              <span class="filter-count">{activeFiltersCount}</span>
            )
          }
        </button>
      </div>

      <div class="universities-grid">
        <aside class="filters-sidebar" id="filtersSidebar">
          <div class="filters-header">
            <h2>Filters</h2>
            {
              activeFiltersCount > 0 && (
                <a href="/universities" class="clear-filters-btn">
                  Clear All
                </a>
              )
            }
          </div>

          <Dropdown 
            options={countries} 
            name="country" 
            label="Country"
            selectedValue={country || ""}
            placeholder="All Countries"
            maxOptionsToShow={8}
          />

          <form class="filters-form" id="filtersForm">
            <!-- Degree Filter -->
            <div class="filter-group">
              <Dropdown 
                options={degrees} 
                name="degree" 
                label="Degree"
                selectedValue={degree || ""}
                placeholder="All Degrees"
                maxOptionsToShow={6}
              />
            </div>

            <!-- Specialization Filter -->
            <div class="filter-group">
              <Dropdown 
                options={specializations} 
                name="specialization" 
                label="Specialization"
                selectedValue={specialization || ""}
                placeholder="All Specializations"
                maxOptionsToShow={8}
              />
            </div>

            <!-- Fee Range Filter -->
            <div class="filter-group">
              <label class="filter-label">Tuition Fee (USD/year)</label>
              <div class="fee-range-inputs">
                <input
                  type="number"
                  name="minFee"
                  placeholder="Min"
                  value={minFee || ""}
                  class="filter-input"
                  min="0"
                  step="1000"
                />
                <span class="range-separator">-</span>
                <input
                  type="number"
                  name="maxFee"
                  placeholder="Max"
                  value={maxFee || ""}
                  class="filter-input"
                  min="0"
                  step="1000"
                />
              </div>
            </div>

            <button type="submit" class="apply-filters-btn"
              >Apply Filters</button
            >
          </form>

          {
            activeFiltersCount > 0 && (
              <div class="active-filters">
                <h3 class="active-filters-title">Active Filters:</h3>
                <div class="filter-tags">
                  {country && (
                    <a
                      href={`/universities?${new URLSearchParams(
                        Object.fromEntries(url.searchParams.entries())
                      )
                        .toString()
                        .replace(/&?country=[^&]*/, "")
                        .replace(/^&/, "")}`}
                      class="filter-tag"
                    >
                      {country}
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="14"
                        height="14"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path d="M18 6L6 18M6 6l12 12" />
                      </svg>
                    </a>
                  )}
                  {degree && (
                    <a
                      href={`/universities?${new URLSearchParams(
                        Object.fromEntries(url.searchParams.entries())
                      )
                        .toString()
                        .replace(/&?degree=[^&]*/, "")
                        .replace(/^&/, "")}`}
                      class="filter-tag"
                    >
                      {degree}
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="14"
                        height="14"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path d="M18 6L6 18M6 6l12 12" />
                      </svg>
                    </a>
                  )}
                  {specialization && (
                    <a
                      href={`/universities?${new URLSearchParams(
                        Object.fromEntries(url.searchParams.entries())
                      )
                        .toString()
                        .replace(/&?specialization=[^&]*/, "")
                        .replace(/^&/, "")}`}
                      class="filter-tag"
                    >
                      {specialization}
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="14"
                        height="14"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path d="M18 6L6 18M6 6l12 12" />
                      </svg>
                    </a>
                  )}
                </div>
              </div>
            )
          }
        </aside>

        <main class="universities-main-content">
          {
            universityCards.length > 0 ? (
              <div class="universities-list">
                {universityCards.map((university) => (
                  <UniversityCard universityCardData={university} />
                ))}
              </div>
            ) : (
              <div class="no-results">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="64"
                  height="64"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                >
                  <circle cx="11" cy="11" r="8" />
                  <path d="m21 21-4.35-4.35" />
                </svg>
                <h3>No universities found</h3>
                <p>Try adjusting your filters to see more results</p>
                <a href="/universities" class="reset-btn">
                  Reset Filters
                </a>
              </div>
            )
          }
        </main>
      </div>
    </div>
  </section>

  <div class="filter-overlay" id="filterOverlay"></div>
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const filterToggle = document.getElementById("filterToggle");
    const filtersSidebar = document.getElementById("filtersSidebar");
    const filterOverlay = document.getElementById("filterOverlay");
    const filtersForm = document.getElementById(
      "filtersForm"
    ) as HTMLFormElement;

    // Mobile filter toggle
    filterToggle?.addEventListener("click", function () {
      filtersSidebar?.classList.toggle("active");
      filterOverlay?.classList.toggle("active");
      document.body.classList.toggle("filter-open");
    });

    filterOverlay?.addEventListener("click", function () {
      filtersSidebar?.classList.remove("active");
      filterOverlay?.classList.remove("active");
      document.body.classList.remove("filter-open");
    });

    // Handle form submission
    filtersForm?.addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(filtersForm);
      const params = new URLSearchParams();

      formData.forEach((value, key) => {
        if (value && value.toString().trim() !== "") {
          params.append(key, value.toString());
        }
      });

      const queryString = params.toString();
      window.location.href = queryString
        ? `/universities?${queryString}`
        : "/universities";
    });

    // Auto-submit on select change for better UX
    const selects = filtersForm?.querySelectorAll("select");
    selects?.forEach((select) => {
      select.addEventListener("change", () => {
        filtersForm?.requestSubmit();
      });
    });
  });
</script>

<style lang="scss">
  @use "../../styles/variables" as *;

  .universities-content {
    padding: 2rem 0;
  }

  .content-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 clamp(1rem, 4vw, 2rem);
  }

  .page-header {
    margin-bottom: 2rem;

    h1 {
      font-size: clamp(1.75rem, 4vw, 2.5rem);
      font-weight: 700;
      color: $text-primary-color;
      margin: 0 0 0.5rem;
    }

    .results-count {
      font-size: 1rem;
      color: $text-gray;
      margin: 0;

      strong {
        color: $primary-color;
        font-weight: 600;
      }
    }
  }

  .mobile-filter-header {
    display: none;
    margin-bottom: 1.5rem;

    @media (max-width: 1024px) {
      display: block;
    }
  }

  .filter-toggle-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-weight: 600;
    color: $text-primary-color;
    cursor: pointer;
    width: 100%;
    justify-content: center;
    position: relative;

    svg {
      color: $primary-color;
    }

    .filter-count {
      position: absolute;
      right: 1rem;
      background: $primary-color;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
    }
  }

  .universities-grid {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 2rem;

    @media (max-width: 1024px) {
      grid-template-columns: 1fr;
    }
  }

  .filters-sidebar {
    position: sticky;
    top: 90px;
    height: fit-content;

    @media (max-width: 1024px) {
      position: fixed;
      top: 0;
      left: -100%;
      width: 85%;
      max-width: 350px;
      height: 100vh;
      background: white;
      z-index: 1001;
      transition: left 0.3s ease;
      overflow-y: auto;
      padding: 1.5rem;
      box-shadow: 4px 0 12px rgba(0, 0, 0, 0.1);

      &.active {
        left: 0;
      }
    }
  }

  .filters-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e5e7eb;

    h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: $text-primary-color;
      margin: 0;
    }
  }

  .clear-filters-btn {
    font-size: 0.875rem;
    color: $primary-color;
    font-weight: 600;
    background: none;
    border: none;
    cursor: pointer;
    text-decoration: none;
    transition: color 0.2s;

    &:hover {
      color: darken($primary-color, 10%);
    }
  }

  .filters-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .filter-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: $text-primary-color;
  }

  .filter-select,
  .filter-input {
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.95rem;
    color: $text-primary-color;
    background: white;
    transition: all 0.2s;

    &:focus {
      outline: none;
      border-color: $primary-color;
      box-shadow: 0 0 0 3px rgba($primary-color, 0.1);
    }
  }

  .fee-range-inputs {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 0.5rem;
    align-items: center;

    .range-separator {
      color: $text-gray;
      font-weight: 600;
    }
  }

  .apply-filters-btn {
    padding: 0.875rem;
    background: $primary-color;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s;

    &:hover {
      background: darken($primary-color, 10%);
      transform: translateY(-1px);
    }
  }

  .active-filters {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;

    .active-filters-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: $text-gray;
      margin: 0 0 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
  }

  .filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .filter-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.75rem;
    background: rgba($primary-color, 0.1);
    color: $primary-color;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;

    svg {
      flex-shrink: 0;
    }

    &:hover {
      background: rgba($primary-color, 0.2);
    }
  }

  .universities-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;

    @media (max-width: 768px) {
      grid-template-columns: 1fr;
    }
  }

  .no-results {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    text-align: center;

    svg {
      color: #d1d5db;
      margin-bottom: 1.5rem;
    }

    h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: $text-primary-color;
      margin: 0 0 0.5rem;
    }

    p {
      color: $text-gray;
      margin: 0 0 1.5rem;
    }

    .reset-btn {
      padding: 0.75rem 1.5rem;
      background: $primary-color;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s;

      &:hover {
        background: darken($primary-color, 10%);
        transform: translateY(-2px);
      }
    }
  }

  .filter-overlay {
    display: none;

    @media (max-width: 1024px) {
      display: block;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(0, 0, 0, 0);
      z-index: 1000;
      pointer-events: none;
      transition: background 0.3s ease;

      &.active {
        background: rgba(0, 0, 0, 0.5);
        pointer-events: auto;
      }
    }
  }
</style>
